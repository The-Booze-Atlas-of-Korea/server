<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ssafy.sulmap.infra.mapper.PlanMapper">

    <!-- DrinkingPlanEntity ResultMap -->
    <resultMap id="PlanResultMap" type="com.ssafy.sulmap.infra.model.DrinkingPlanEntity">
        <id property="id" column="id"/>
        <result property="ownerUserId" column="owner_user_id"/>
        <result property="title" column="title"/>
        <result property="description" column="description"/>
        <result property="theme" column="theme"/>
        <result property="totalBudget" column="total_budget"/>
        <result property="createdAt" column="created_at"/>
        <result property="updatedAt" column="updated_at"/>
    </resultMap>

    <!-- DrinkingPlanSpotEntity ResultMap -->
    <resultMap id="PlanSpotResultMap" type="com.ssafy.sulmap.infra.model.DrinkingPlanSpotEntity">
        <id property="id" column="id"/>
        <result property="planId" column="plan_id"/>
        <result property="placeId" column="place_id"/>
        <result property="placeNameSnapshot" column="place_name_snapshot"/>
        <result property="placeAddressSnapshot" column="place_address_snapshot"/>
        <result property="latitude" column="latitude"/>
        <result property="longitude" column="longitude"/>
        <result property="sequence" column="sequence"/>
        <result property="memo" column="memo"/>
    </resultMap>

    <!-- 플랜 삽입 -->
    <insert id="insertPlan" parameterType="com.ssafy.sulmap.infra.model.DrinkingPlanEntity"
            useGeneratedKeys="true" keyProperty="id" keyColumn="id">
        INSERT INTO drinking_plan (owner_user_id, title, description, theme, total_budget, created_at, updated_at)
        VALUES (#{ownerUserId}, #{title}, #{description}, #{theme}, #{totalBudget}, #{createdAt}, #{updatedAt})
    </insert>

    <!-- 플랜 스팟 삽입 -->
    <insert id="insertPlanSpot" parameterType="com.ssafy.sulmap.infra.model.DrinkingPlanSpotEntity"
            useGeneratedKeys="true" keyProperty="id" keyColumn="id">
        INSERT INTO drinking_plan_spot (plan_id, place_id, place_name_snapshot, place_address_snapshot, 
                                        latitude, longitude, sequence, memo)
        VALUES (#{planId}, #{placeId}, #{placeNameSnapshot}, #{placeAddressSnapshot}, 
                #{latitude}, #{longitude}, #{sequence}, #{memo})
    </insert>

    <!-- 플랜 단건 조회 -->
    <select id="selectById" parameterType="long" resultMap="PlanResultMap">
        SELECT id, owner_user_id, title, description, theme, total_budget, created_at, updated_at
        FROM drinking_plan
        WHERE id = #{id}
    </select>

    <!-- 사용자별 플랜 목록 조회 -->
    <select id="selectByOwnerUserId" parameterType="long" resultMap="PlanResultMap">
        SELECT id, owner_user_id, title, description, theme, total_budget, created_at, updated_at
        FROM drinking_plan
        WHERE owner_user_id = #{ownerUserId}
        ORDER BY created_at DESC
    </select>

    <!-- 특정 플랜의 스팟 목록 조회 -->
    <select id="selectSpotsByPlanId" parameterType="long" resultMap="PlanSpotResultMap">
        SELECT id, plan_id, place_id, place_name_snapshot, place_address_snapshot, 
               latitude, longitude, sequence, memo
        FROM drinking_plan_spot
        WHERE plan_id = #{planId}
        ORDER BY sequence ASC
    </select>

    <!-- 플랜 수정 -->
    <update id="updatePlan" parameterType="com.ssafy.sulmap.infra.model.DrinkingPlanEntity">
        UPDATE drinking_plan
        <set>
            <if test="title != null">title = #{title},</if>
            <if test="description != null">description = #{description},</if>
            <if test="theme != null">theme = #{theme},</if>
            <if test="totalBudget != null">total_budget = #{totalBudget},</if>
            updated_at = NOW()
        </set>
        WHERE id = #{id}
    </update>

    <!-- 특정 플랜의 모든 스팟 삭제 -->
    <delete id="deleteSpotsByPlanId" parameterType="long">
        DELETE FROM drinking_plan_spot
        WHERE plan_id = #{planId}
    </delete>

    <!-- 플랜 삭제 -->
    <delete id="deletePlan" parameterType="long">
        DELETE FROM drinking_plan
        WHERE id = #{id}
    </delete>

    <select id="selectByOwnerUserIdWithPaging" resultMap="PlanResultMap">
        SELECT id, owner_user_id, title, description, theme, total_budget, created_at, updated_at
        FROM drinking_plan
        WHERE owner_user_id = #{ownerUserId}
        ORDER BY
        <choose>
            <when test="sort == 'createdAt,asc'">created_at ASC</when>
            <when test="sort == 'createdAt,desc'">created_at DESC</when>
            <otherwise>created_at DESC</otherwise>
        </choose>
        LIMIT #{limit} OFFSET #{offset}
    </select>

</mapper>
